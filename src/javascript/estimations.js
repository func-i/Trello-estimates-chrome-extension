// Generated by CoffeeScript 1.6.2
(function() {
  var cardDetailsIsOpen, loadCode, timer;

  cardDetailsIsOpen = function() {
    return document.URL.indexOf("trello.com/card/") >= 0;
  };

  loadCode = function() {
    var bindEstimationModalEvents, buildEstimationObject, cardPattern, createBoardEstimationButton, createCardEstimationButton, createCardEstimationModal, createDisplayEstimations, generateHTMLCode, getBoardId, getCardId, getUsername, matchPattern, populateEstimationSection, sendEstimation, setEstimationTime, userNamePattern;

    cardPattern = /^https:\/\/trello.com\/card\/(\S+)\/(\S+)\/(\d+)$/;
    userNamePattern = /^\(\S*\)/;
    matchPattern = function(string, pattern) {
      return string.match(pattern);
    };
    getBoardId = function() {
      return matchPattern(document.URL, cardPattern)[2];
    };
    getCardId = function() {
      return matchPattern(document.URL, cardPattern)[3];
    };
    getUsername = function() {
      var beginParenthesis, endParenthesis, userFullName;

      userFullName = $.trim($(".header-auth").find(".member-avatar").attr("title"));
      beginParenthesis = userFullName.lastIndexOf("(");
      endParenthesis = userFullName.lastIndexOf(")");
      userFullName = userFullName.substr(beginParenthesis + 1);
      return userFullName.substr(0, userFullName.length - 1);
    };
    setEstimationTime = function(time) {
      return $("#estimation_time").val(time);
    };
    buildEstimationObject = function() {
      var developerEstimation, estimation, managerEstimation;

      managerEstimation = $("#manager_estimation_time").val();
      developerEstimation = $("#estimation_time").val();
      estimation = {
        board_id: getBoardId(),
        card_id: getCardId()
      };
      if ($.trim(developerEstimation).length > 0) {
        return estimation = $.extend(estimation, {
          type: "developer",
          user_time: developerEstimation,
          user_username: getUsername()
        });
      } else {
        return estimation = $.extend(estimation, {
          type: "manager",
          user_time: managerEstimation,
          user_username: getUsername()
        });
      }
    };
    sendEstimation = function() {
      return $.ajax("http://localhost:3000/estimations", {
        method: "post",
        data: {
          estimation: buildEstimationObject()
        },
        async: false,
        success: function(response) {
          return $("#estimation_dialog").dialog("close");
        }
      });
    };
    createBoardEstimationButton = function() {
      return $.ajax(chrome.extension.getURL("src/html/estimation_btn.html"), {
        dataType: 'html',
        success: function(html) {
          $(".list-card .badges").each(function() {});
          return $(this).append(html);
        }
      });
    };
    bindEstimationModalEvents = function() {
      return $("#estimation_modal_btn").click(function(e) {
        e.preventDefault();
        e.stopPropagation();
        sendEstimation();
        return false;
      });
    };
    createCardEstimationModal = function() {
      return $.ajax(chrome.extension.getURL("src/html/estimation_modal.html"), {
        dataType: 'html',
        success: function(html) {
          $("body").append(html);
          bindEstimationModalEvents();
          return $("#estimation_dialog").dialog({
            autoOpen: false,
            modal: true
          });
        }
      });
    };
    createCardEstimationButton = function() {
      return $.ajax(chrome.extension.getURL("src/html/card_estimation_btn.html"), {
        dataType: 'html',
        success: function(html) {
          $(".other-actions").find(".clearfix").prepend(html);
          createCardEstimationModal();
          return $(".js-add-estimation-menu").on("click", function() {
            return $("#estimation_dialog").dialog("open");
          });
        }
      });
    };
    populateEstimationSection = function() {
      return $.ajax("http://localhost:3000/estimations", {
        data: {
          boardId: getBoardId(),
          cardId: getCardId()
        },
        async: false,
        success: function(response) {
          var estimation, html, _i, _len, _results;

          _results = [];
          for (_i = 0, _len = response.length; _i < _len; _i++) {
            estimation = response[_i];
            html = "<tr><td>" + estimation.developer_name + "</td><td>" + estimation.developer_time + "</td><td>" + estimation.manager_name + "</td><td>" + estimation.manager_time + "</td></tr>";
            _results.push($(".estimations").find("tbody").append(html));
          }
          return _results;
        }
      });
    };
    createDisplayEstimations = function() {
      return $.ajax(chrome.extension.getURL("src/html/estimations.html"), {
        dataType: 'html',
        success: function(html) {
          $(".card-detail-metadata").prepend(html);
          return populateEstimationSection();
        }
      });
    };
    generateHTMLCode = function() {
      createBoardEstimationButton();
      if (cardDetailsIsOpen()) {
        createCardEstimationButton();
        return createDisplayEstimations();
      }
    };
    return generateHTMLCode();
  };

  timer = setInterval(function() {
    if ($(".other-actions").length > 0) {
      loadCode();
      return clearInterval(timer);
    }
  }, 250);

}).call(this);
